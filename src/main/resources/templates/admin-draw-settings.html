<!DOCTYPE html>
<html lang="tr" class="loading"
      xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">
  
<head th:replace="admin-template :: head"></head>
  <body data-col="2-columns" class=" 2-columns ">
    <div class="wrapper">
      <!--.main-menu(class="#{menuColor} #{menuOpenType}", class=(menuShadow == true ? 'menu-shadow' : ''))-->
        <div th:replace="admin-template :: sidebar"></div>

        <!-- / main menu-->

      <div class="main-panel">

        <!-- Navbar (Header) Starts-->
          <nav th:replace="admin-template :: header" class="navbar navbar-expand-lg navbar-light bg-faded"></nav>

          <!-- Navbar (Header) Ends-->

        <div class="main-content">
          <div class="content-wrapper"><!--Statistics cards Starts-->
              <div th:replace="admin-template :: messages"></div>


              <div class="row">
            <div class="col-md-5">

			<div class="card">
				<div class="card-header">
					<h4 class="card-title" id="basic-layout-colored-form-control">ÇEKİLİŞ AYARLARI</h4>
				</div>
				<div class="card-body">
					<div class="px-3">						

						<form class="form" id="form" action="/admin/draw-prize" method="post">
							<div class="form-body">
								<h4 class="form-section"><i class="ft-info"></i> Paket Oluştur</h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="mainCategorySelect">Ana Kategori</label>
                                            <select id="mainCategorySelect" name="priority" class="form-control" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-title="Priority">
                                                <option value="0" disabled="disabled" selected="selected" >Seçim Yapınız !</option>
                                                <option th:each="maincategory : ${maincategories}"
                                                        th:text="${maincategory.getName()}"
                                                        th:value="${maincategory.getId()}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="subcategory">Alt Kategori</label>
                                            <select id="subcategory" name="priority" class="form-control" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-title="Priority">
                                                <option value="0" disabled="disabled" selected="selected" >Seçim Yapınız !</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="service">Servis</label>
                                    <select id="service" name="service" class="form-control" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-title="Priority">
                                        <option value="0" disabled="disabled" selected="selected" >Seçim Yapınız !</option>
                                    </select>
                                </div>
								<div class="form-group">
									<label for="packageName">Ödül Adı</label>
									<input autocomplete="off" required type="text" id="packageName" name="name" class="form-control">
								</div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="quantity">Miktar</label>
                                            <input onkeypress='validate(event)' required type="text" name="quantity" id="quantity" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="apiPrice">Api Fiyatı</label>
                                            <input type="text" class="form-control text-center" required id="apiPrice" readonly="readonly">
                                        </div>
                                    </div>
                                </div>
							</div>

							<div class="form-actions right">
								<button type="submit" class="btn btn-raised btn-block white gradient-plum">
									<i class="fa fa-check-square-o"></i> Kaydet
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
                  <div class="col-md-7">
                      <div class="alert gradient-yellow-teal mb-2 text-center" role="alert">
                          İstediğiniz kadar ödülü aktif duruma getirebilirsiniz. Fakat çekiliş çarkı sadece daha önce oluşturulmuş ve aktif
                          durumda bulunan ilk 3 ödülü kullanarak dilimleri oluşturur. Bu 3 ödülden fiyatı en düşün olanı 3 kez, diğerini 2 kez,
                          en pahalı olanı 1 kez kullanarak toplam 6 dilimlik bir çark oluşturulur.
                          İstenildiği kadar ödülün aktif edilebilmesinin sebebi servislerin bazılarının pasif duruma gelmesi sonucu çarkta bir
                          problem yaşanmasını önlemektir. Her koşulda 3 adet ödül bulundurmanızı tavsiye ederiz.
                      </div>
                      <section id="bootstrap3">
                          <div class="row" >
                              <div class="col-12">
                                  <div class="card">
                                      <div class="card-header">
                                          <h3 class="card-title">Ödül Listesi</h3>
                                      </div>
                                      <div class="card-body collapse show" >
                                          <div class="card-block card-dashboard" style="padding-top: 10px !important; overflow-x: scroll" >
                                              <table class="table table-striped table-bordered bootstrap-3" >
                                                  <thead>
                                                      <tr>
                                                          <th>Name</th>
                                                          <th>Service</th>
                                                          <th>Quantity</th>
                                                          <th>Api Price</th>
                                                          <th>State</th>
                                                          <th>Action</th>
                                                      </tr>
                                                  </thead>
                                                  <tbody>
                                                      <tr th:each="drawprize : ${drawPrizes}">
                                                          <td th:text="${drawprize.getName()}"></td>
                                                          <td th:text="${drawprize.getService().getSubCategory().getCategory().getName() + ' - ' + drawprize.getService().getId() + ':' + drawprize.getService().getCustomName()}"></td>
                                                          <td th:text="${drawprize.getQuantity()}"></td>
                                                          <td th:text="${drawprize.getApiPrice()}"></td>
                                                          <td>
                                                            <span th:if="${drawprize.isState() == true}" style="color: white; background-color: #0CC27E; padding: 3px 5px 3px 5px; border-radius: 3px;">
                                                                Aktif
                                                            </span>
                                                            <span th:if="${drawprize.isState() == false}" style="color: white; background-color: #FF586B; padding: 3px 5px 3px 5px; border-radius: 3px;">
                                                                Pasif
                                                            </span>
                                                          </td>
                                                          <td>
                                                              <a th:href="@{'/admin/draw-prize/activate/' + ${drawprize.getId()}}" th:if="${drawprize.isState() == false}"
                                                                 class="info p-0" data-original-title="" title="Activate">
                                                                  <i class="ft-plus-circle font-medium-3 mr-2"></i>
                                                              </a>
                                                              <a th:href="@{'/admin/draw-prize/passivate/' + ${drawprize.getId()}}" th:if="${drawprize.isState() == true}"
                                                                 class="danger p-0" data-original-title="" title="Passivate">
                                                                  <i class="ft-minus-circle font-medium-3 mr-2"></i>
                                                              </a>
                                                          </td>
                                                      </tr>
                                                  </tbody>
                                                  <tfoot>
                                                      <tr>
                                                          <th>Name</th>
                                                          <th>Service</th>
                                                          <th>Quantity</th>
                                                          <th>Api Price</th>
                                                          <th>State</th>
                                                          <th>Action</th>
                                                      </tr>
                                                  </tfoot>
                                              </table>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </section>
                  </div>
                </div>
          </div>
        </div>
      </div>
    </div>
    <script th:src="@{/vendors/js/core/jquery-3.2.1.min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/core/popper.min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/core/bootstrap.min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/perfect-scrollbar.jquery.min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/prism.min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/jquery.matchHeight-min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/screenfull.min.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/pace/pace.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/app-sidebar.js}" type="text/javascript"></script>
    <script th:src="@{/js/notification-sidebar.js}" type="text/javascript"></script>
    <script th:src="@{/js/customizer.js}" type="text/javascript"></script>
    <script th:src="@{/vendors/js/datatable/datatables.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/data-tables/datatable-styling.js}" type="text/javascript"></script>
    <script src="https://cdn.ckeditor.com/4.11.4/full/ckeditor.js"></script>
    <script>

        $('#mainCategorySelect').change(
            function () {
                $.getJSON("/admin/categories/subcategory", {
                    maincategoryId : $(this).val(),
                    ajax : 'true'
                }, function (data) {
                    var html = '<option value="0" disabled="disabled" selected="selected" >Seçim Yapınız !</option>';
                    var len = data.length;
                    for ( var i = 0; i < len; i++) {
                        html += '<option value="' + data[i].id + '">' +
                           data[i].name
                            + '</option>';
                    }
                    $('#subcategory').html(html);
                })
            }
        );


        $('#subcategory').change(
            function () {
                $.getJSON("/admin/services/service-category", {
                    subcategoryId : $(this).val(),
                    ajax : 'true'
                }, function (data) {
                    var html = '<option value="0" disabled="disabled" selected="selected" >Seçim Yapınız !</option>';
                    var len = data.length;
                    for ( var i = 0; i < len; i++) {
                        html += '<option value="' + data[i].id + '">' +
                            data[i].id + ' - ' + data[i].customName + '(min: ' + data[i].customMinPiece + ' - max: ' + data[i].customMaxPiece + ') -> 1K: ₺' + data[i].customPrice
                            + '</option>';
                    }
                    $('#service').html(html);
                })
            }
        );

        var customprice = 0;
        var apiprice = 0;
        var maxcount = 0;
        var mincount = 0;

        $('#service').change(
            function () {
                $.getJSON("/admin/services/service-id", {
                    serviceId: $(this).val(),
                    ajax: 'true'
                }, function (data) {
                    customprice = data.customPrice;
                    apiprice = data.apiPrice;
                    maxcount = data.customMaxPiece;
                    mincount = data.customMinPiece;
                    $('#quantity').val(1000);
                    $('#apiPrice').val(apiprice + ' ₺');

                })
            }
        );

        $("#form").submit( function(e) {

            if ( $('#service').val() == null ){
                alert( 'Paket oluşturmak için bir servis seçmelisiniz !' );
                e.preventDefault();
                return;
            }

            if ($('#quantity').val()<mincount || $('#quantity').val()>maxcount){
                alert( 'Bu miktardaki pakete sistem izin vermiyor !' );
                e.preventDefault();
                return;
            }

        });

        function validate(evt) {
            var theEvent = evt || window.event;

            // Handle paste
            if (theEvent.type === 'paste') {
                key = event.clipboardData.getData('text/plain');
            } else {
                // Handle key press
                var key = theEvent.keyCode || theEvent.which;
                key = String.fromCharCode(key);
            }
            var regex = /[0-9]|\./;
            if( !regex.test(key) ) {
                theEvent.returnValue = false;
                if(theEvent.preventDefault) theEvent.preventDefault();
            }
        }

        $('#quantity').on('change keydown keypress keyup mousedown click mouseup', function (evt) {
            var quantity = $(this).val();
            $('#apiPrice').val(quantity * (apiprice/1000) + ' ₺');

        });
    </script>
  </body>

</html>